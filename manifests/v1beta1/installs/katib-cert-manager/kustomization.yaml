---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: kubeflow
resources:
  # Namespace.
  - ../../components/namespace
  # Katib controller.
  - ../../components/controller/
  # Katib CRDs.
  - ../../components/crd/
  # Katib DB manager.
  - ../../components/db-manager/
  # Katib DB mysql.
  - ../../components/mysql/
  # Katib UI.
  - ../../components/ui/
  # Katib webhooks.
  - ../../components/webhook/
  # Cert-manager certificate for webhooks
  - certificate.yaml
images:
  - name: docker.io/kubeflowkatib/katib-controller
    newName: docker.io/kubeflowkatib/katib-controller
    newTag: latest
  - name: docker.io/kubeflowkatib/katib-db-manager
    newName: docker.io/kubeflowkatib/katib-db-manager
    newTag: latest
  - name: docker.io/kubeflowkatib/katib-ui
    newName: docker.io/kubeflowkatib/katib-ui
    newTag: latest

patches:
- path: patches/katib-cert-injection.yaml
replacements:
- source:
    fieldPath: metadata.namespace
    kind: Service
    name: katib-controller
    version: v1
  targets:
  - fieldPaths:
    - spec.commonName
    options:
      delimiter: .
      index: 1
    select:
      group: cert-manager.io
      kind: Certificate
      name: katib-webhook-cert
      version: v1
  - fieldPaths:
    - spec.dnsNames.0
    options:
      delimiter: .
      index: 1
    select:
      group: cert-manager.io
      kind: Certificate
      name: katib-webhook-cert
      version: v1
  - fieldPaths:
    - spec.dnsNames.1
    options:
      delimiter: .
      index: 1
    select:
      group: cert-manager.io
      kind: Certificate
      name: katib-webhook-cert
      version: v1
  - fieldPaths:
    - metadata.annotations.[cert-manager.io/inject-ca-from]
    options:
      delimiter: /
      index: 1
    select:
      kind: ValidatingWebhookConfiguration
      name: katib.kubeflow.org
  - fieldPaths:
    - metadata.annotations.[cert-manager.io/inject-ca-from]
    options:
      delimiter: /
      index: 1
    select:
      kind: MutatingWebhookConfiguration
      name: katib.kubeflow.org
- source:
    fieldPath: metadata.name
    kind: Service
    name: katib-controller
    version: v1
  targets:
  - fieldPaths:
    - spec.commonName
    options:
      delimiter: .
    select:
      group: cert-manager.io
      kind: Certificate
      name: katib-webhook-cert
      version: v1
  - fieldPaths:
    - spec.dnsNames.0
    options:
      delimiter: .
    select:
      group: cert-manager.io
      kind: Certificate
      name: katib-webhook-cert
      version: v1
  - fieldPaths:
    - spec.dnsNames.1
    options:
      delimiter: .
    select:
      group: cert-manager.io
      kind: Certificate
      name: katib-webhook-cert
      version: v1
- source:
    fieldPath: metadata.name
    kind: Certificate
    name: katib-webhook-cert
  targets:
  - fieldPaths:
    - metadata.annotations.[cert-manager.io/inject-ca-from]
    options:
      delimiter: /
      index: 1
    select:
      kind: ValidatingWebhookConfiguration
      name: katib.kubeflow.org
  - fieldPaths:
    - metadata.annotations.[cert-manager.io/inject-ca-from]
    options:
      delimiter: /
      index: 1
    select:
      kind: MutatingWebhookConfiguration
      name: katib.kubeflow.org

configurations:
  - params.yaml

configMapGenerator:
  - name: katib-config
    behavior: create
    files:
      - katib-config.yaml
    options:
      disableNameSuffixHash: true

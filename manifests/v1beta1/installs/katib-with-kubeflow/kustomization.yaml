---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: kubeflow
resources:
  - ../katib-cert-manager
  # Kubeflow Katib components.
  - kubeflow-katib-roles.yaml
  - ui-virtual-service.yaml
  - istio-authorizationpolicy.yaml
images:
  - name: docker.io/kubeflowkatib/katib-controller
    newName: docker.io/kubeflowkatib/katib-controller
    newTag: v0.17.0
  - name: docker.io/kubeflowkatib/katib-db-manager
    newName: docker.io/kubeflowkatib/katib-db-manager
    newTag: v0.17.0
  - name: docker.io/kubeflowkatib/katib-ui
    newName: docker.io/kubeflowkatib/katib-ui
    newTag: v0.17.0

patches:
  - path: patches/remove-namespace.yaml
  # Extend RBAC permission list of katib-ui so it can
  # create SubjectAccessReview resources.
  - target:
      kind: ClusterRole
      name: katib-ui
      group: rbac.authorization.k8s.io
      version: v1
    path: patches/ui-rbac.yaml
  # Enable RBAC authz checks in UI's backend.
  - target:
      version: v1
      kind: Deployment
      name: katib-ui
    path: patches/enable-ui-authz-checks.yaml
  # Allow istio sidecar injection in katib-UI Pod.
  - target:
      kind: Deployment
      name: katib-ui
    path: patches/istio-sidecar-injection.yaml

replacements:
- source:
    fieldPath: metadata.namespace
    group: apps
    kind: Deployment
    name: katib-ui
    version: v1
  targets:
  - fieldPaths:
    - spec.http.0.route.0.destination.host
    options:
      delimiter: .
      index: 1
    select:
      group: networking.istio.io
      kind: VirtualService
      name: katib-ui
      version: v1alpha3

configurations:
  - params.yaml
